<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chá Revelação - Miguel ou Catarina</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Google GenAI SDK (ESM) -->
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.run/@google/genai"
  }
}
    </script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Nunito', 'sans-serif'],
              heading: ['Fredoka', 'sans-serif'],
            },
            colors: {
              babyBlue: '#A0D2EB',
              babyBlueDark: '#5CA0D3',
              babyPink: '#F5A3C7',
              babyPinkDark: '#D86B99',
            }
          }
        }
      }
    </script>
    <style>
      body { background-color: #fdfdfd; }
      .animate-float { animation: float 3s ease-in-out infinite; }
      @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
      }
      .glass {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.9);
      }
      .blur-name {
        filter: blur(3px);
        opacity: 0.9;
        user-select: none;
      }
      .masked-name {
        position: relative;
        display: inline-block;
        padding: 0 6px;
      }
      .masked-name::after {
        content: "";
        position: absolute;
        left: -2px;
        right: -2px;
        top: 50%;
        height: 90%;
        transform: translateY(-50%);
        background: linear-gradient(90deg, rgba(255, 255, 255, 0.7) 0%, rgba(255, 255, 255, 0.25) 50%, rgba(255, 255, 255, 0.7) 100%);
        border-radius: 999px;
        pointer-events: none;
        box-shadow: inset 0 0 0 1px rgba(226, 232, 240, 0.7);
      }
      .recent-votes-list {
        max-height: 240px;
        overflow-y: auto;
        padding-right: 4px;
      }
      .recent-votes-list::-webkit-scrollbar {
        width: 6px;
      }
      .recent-votes-list::-webkit-scrollbar-track {
        background: transparent;
      }
      .recent-votes-list::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.6);
        border-radius: 999px;
      }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-100 via-white to-pink-100 font-sans text-gray-800 overflow-x-hidden relative selection:bg-blue-200">

    <!-- Background Shapes -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
        <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-blue-200/40 rounded-full blur-[100px] animate-pulse"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-pink-200/40 rounded-full blur-[100px] animate-pulse" style="animation-delay: 2s"></div>
    </div>

    <main class="relative z-10 max-w-5xl mx-auto px-4 py-8 flex flex-col items-center">
        
        <!-- Header -->
        <header class="text-center mb-8 relative w-full">
            <div class="inline-flex items-center gap-2 px-4 py-1.5 bg-white/80 backdrop-blur-md rounded-full shadow-sm text-xs font-bold tracking-widest text-blue-500 mb-6 border border-white uppercase">
                ✨ Chá Revelação
            </div>
            
            <div class="relative">
                <h1 class="text-5xl md:text-8xl font-heading font-black mb-4 drop-shadow-sm leading-tight tracking-tight">
                    <span class="text-[#5CA0D3]">Miguel</span>
                    <span class="text-3xl md:text-5xl text-gray-300 font-light align-middle mx-3">ou</span>
                    <span class="block md:inline text-[#D86B99]">Catarina</span>
                </h1>
            </div>
            
            <p class="text-gray-500 font-medium text-lg md:text-xl max-w-2xl mx-auto">
                Venha celebrar com a gente e deixe seu palpite para o grande momento!
            </p>
        </header>

        <!-- Info Cards -->
        <div class="flex flex-col md:flex-row gap-4 w-full max-w-2xl justify-center mb-10">
            <div class="glass p-4 rounded-2xl flex items-center gap-3 shadow-sm flex-1">
                <div class="bg-blue-100 p-3 rounded-xl text-blue-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                </div>
                <div>
                    <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">Data</p>
                    <p class="font-heading font-bold text-gray-800 text-lg">14/02/2026</p>
                    <p class="text-sm text-gray-500">Sábado às 15:30</p>
                </div>
            </div>
            
            <div class="glass p-4 rounded-2xl flex items-center gap-3 shadow-sm flex-1">
                <div class="bg-pink-100 p-3 rounded-xl text-pink-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                </div>
                <div>
                    <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">Local</p>
                    <p class="font-heading font-bold text-gray-800 text-lg">Casa da Vovó</p>
                    <p class="text-sm text-gray-500">Rua da Felicidade, 123</p>
                </div>
            </div>
        </div>

        <!-- Countdown -->
        <div id="countdown" class="flex gap-3 sm:gap-6 justify-center mb-8">
            <!-- Populated by JS -->
        </div>

        <!-- Palpite Intro -->
        <section class="w-full max-w-4xl text-center mt-2">
            <h2 class="text-3xl md:text-4xl font-heading font-black text-gray-800">Qual é o seu palpite?</h2>
            <p class="text-gray-500 mt-2">Digite seu nome, escolha Miguel ou Catarina e confirme o voto.</p>
            <div class="mt-5 flex flex-wrap justify-center gap-3 text-[11px] font-bold uppercase tracking-[0.2em] text-gray-500">
                <span class="px-4 py-2 bg-white/70 border border-white rounded-full shadow-sm">1. Seu nome</span>
                <span class="px-4 py-2 bg-white/70 border border-white rounded-full shadow-sm">2. Escolha o time</span>
                <span class="px-4 py-2 bg-white/70 border border-white rounded-full shadow-sm">3. Confirmar voto</span>
            </div>
        </section>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 w-full mt-8">
            
            <!-- Voting Form -->
            <div class="lg:col-span-7">
                <div class="glass rounded-3xl shadow-xl overflow-hidden h-full flex flex-col p-6 md:p-8">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
                        <div>
                            <p class="text-xs font-bold uppercase tracking-widest text-blue-500">Seu palpite</p>
                            <h3 class="text-xl md:text-2xl font-heading font-black text-gray-800">Conte para a gente</h3>
                        </div>
                        <div class="text-xs font-bold text-pink-500 bg-pink-50 border border-pink-100 px-3 py-1 rounded-full">
                            Miguel ou Catarina
                        </div>
                    </div>
                    
                    <form id="votingForm" class="space-y-8">
                        <div>
                            <div class="flex items-center gap-2 text-sm font-bold text-gray-600 uppercase tracking-wider mb-2">
                                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-blue-50 text-blue-500 text-xs">1</span>
                                Seu nome
                            </div>
                            <label for="guestName" class="block text-sm font-bold text-gray-600 mb-2 ml-1">Como devemos te chamar?</label>
                            <input type="text" id="guestName" placeholder="Ex: Titia Maria, Vovô João..." class="w-full px-5 py-4 rounded-xl border border-gray-200 bg-white/90 focus:bg-white focus:border-blue-300 focus:ring-4 focus:ring-blue-100 transition-all outline-none text-lg text-gray-700 shadow-sm placeholder:text-gray-400" required>
                        </div>

                        <div class="flex items-center gap-2 text-sm font-bold text-gray-600 uppercase tracking-wider">
                            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-blue-50 text-blue-500 text-xs">2</span>
                            Escolha o time
                        </div>

                        <div class="grid grid-cols-2 gap-4 md:gap-6">
                            <!-- Boy Option -->
                            <div id="btnBoy" class="cursor-pointer relative group rounded-2xl border-2 p-6 flex flex-col items-center justify-center transition-all duration-300 border-gray-100 bg-white/90 hover:border-blue-200 hover:shadow-lg hover:-translate-y-1" onclick="selectGender('BOY')">
                                <div class="w-20 h-20 rounded-full flex items-center justify-center mb-4 bg-blue-100 text-blue-500 group-hover:bg-blue-200 transition-colors" id="iconBoy">
                                    <img src="boy.png" alt="Menino" class="w-12 h-12 object-contain" />
                                </div>
                                <span class="font-heading font-black text-xl text-gray-400 group-hover:text-blue-400" id="textBoy">Miguel</span>
                                <span class="text-xs font-bold tracking-widest text-blue-300 mt-1 uppercase">Menino</span>
                            </div>

                            <!-- Girl Option -->
                            <div id="btnGirl" class="cursor-pointer relative group rounded-2xl border-2 p-6 flex flex-col items-center justify-center transition-all duration-300 border-gray-100 bg-white/90 hover:border-pink-200 hover:shadow-lg hover:-translate-y-1" onclick="selectGender('GIRL')">
                                <div class="w-20 h-20 rounded-full flex items-center justify-center mb-4 bg-pink-100 text-pink-400 group-hover:bg-pink-200 transition-colors" id="iconGirl">
                                    <img src="girl.png" alt="Menina" class="w-12 h-12 object-contain" />
                                </div>
                                <span class="font-heading font-black text-xl text-gray-400 group-hover:text-pink-400" id="textGirl">Catarina</span>
                                <span class="text-xs font-bold tracking-widest text-pink-300 mt-1 uppercase">Menina</span>
                            </div>
                        </div>

                        <div class="flex items-center gap-2 text-sm font-bold text-gray-600 uppercase tracking-wider">
                            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-pink-50 text-pink-500 text-xs">3</span>
                            Confirmar
                        </div>

                        <button type="submit" id="submitBtn" disabled class="w-full py-4 rounded-xl font-bold text-lg text-white shadow-xl flex items-center justify-center gap-2 transition-all transform hover:shadow-2xl active:scale-95 bg-gray-400 cursor-not-allowed">
                            Confirmar Voto
                        </button>
                    </form>

                    <!-- AI Feedback -->
                    <div id="aiFeedback" class="hidden mt-8 p-6 bg-gradient-to-br from-yellow-50 to-orange-50 border border-yellow-200 rounded-2xl shadow-sm relative overflow-hidden animate-float">
                        <div class="flex items-start gap-4 relative z-10">
                            <div class="bg-yellow-400 p-2 rounded-lg text-white shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
                            </div>
                            <div>
                                <h4 class="font-bold text-yellow-800 text-sm uppercase mb-1 tracking-wide">Mensagem Especial</h4>
                                <p id="aiMessageText" class="text-gray-700 font-medium italic text-lg leading-relaxed"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats & Chart -->
            <div class="lg:col-span-5 flex flex-col gap-6">
                <div class="glass rounded-2xl shadow-sm border border-white p-6 flex flex-col items-center">
                    <h3 class="text-lg font-heading font-bold text-gray-800 mb-4 w-full text-left flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
                        Placar da Galera
                    </h3>
                    <p class="text-sm text-gray-500 w-full text-left -mt-2 mb-4">Veja como estão os palpites até agora.</p>
                    
                    <div class="relative w-48 h-48">
                        <canvas id="voteChart"></canvas>
                    </div>

                    <div class="w-full grid grid-cols-2 gap-4 mt-6">
                        <div class="bg-blue-50 border border-blue-100 rounded-2xl p-4 flex flex-col items-center shadow-sm">
                           <span class="text-xs text-blue-400 font-bold uppercase mb-1">Time Miguel</span>
                           <span class="text-2xl font-bold text-blue-600" id="statMiguel">0%</span>
                        </div>
               
                        <div class="bg-pink-50 border border-pink-100 rounded-2xl p-4 flex flex-col items-center shadow-sm">
                           <span class="text-xs text-pink-400 font-bold uppercase mb-1">Time Catarina</span>
                           <span class="text-2xl font-bold text-pink-600" id="statCatarina">0%</span>
                        </div>
                     </div>
                </div>
                <div class="glass rounded-2xl shadow-sm border border-white p-6">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-heading font-bold text-gray-800">Últimos palpites</h3>
                        <span class="text-[11px] font-bold uppercase tracking-widest text-gray-400">Agora</span>
                    </div>
                    <div id="recentVotes" class="mt-4 space-y-3 recent-votes-list">
                        <p class="text-sm text-gray-400">Seja o primeiro a votar!</p>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-20 text-center text-gray-400 text-sm pb-8">
            <p class="font-medium opacity-50">Feito com carinho para Miguel e Catarina ❤️</p>
            <p class="mt-3 text-xs text-gray-400">
                Desenvolvido por <span class="font-bold text-gray-500">SOUUS CONSULTORIA E TERCEIRIZAÇÃO</span> ·
                <a
                    class="ml-1 font-bold text-blue-500 hover:text-blue-600 underline underline-offset-4"
                    href="https://wa.me/5562981889853?text=Ol%C3%A1%2C%20vi%20o%20site%20que%20voc%C3%AA%20fez%20e%20quero%20solicitar%20o%20um%20or%C3%A7amento."
                    target="_blank"
                    rel="noopener noreferrer"
                >
                    WhatsApp: (62) 98188-9853
                </a>
            </p>
        </footer>

    </main>

    <!-- LOGIC -->
    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        // CONFIGURATION
        // NOTE: The deploy script replaces __API_KEY_PLACEHOLDER__ with the actual secret
        const API_KEY = '__API_KEY_PLACEHOLDER__'; 
        
        const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbzsSd8afh7jGQwmR5S3J8Abb98H2x4KHqGi38GM5DAwc8xPGxipud5tP3kYu-OCnFL3HQ/exec";
        const TARGET_DATE = new Date('2026-02-14T15:30:00').getTime();

        // STATE
        let votes = [];
        let selectedGender = null;
        let chartInstance = null;
        const fallbackMessages = [
            "Voto registrado! Que venha um dia cheio de amor e alegria.",
            "Seu palpite chegou! A festa vai ser inesquecivel.",
            "Obrigada(o) pelo carinho! A revelacao vai encantar.",
            "Voto confirmado! Que a celebracao seja doce e leve.",
            "Palpite anotado com amor! Prepare o coracao.",
            "Registramos seu voto! Que a alegria transborde.",
            "Tudo certo! Seu palpite deixou o clima ainda mais lindo.",
            "Voto feito! Em breve a surpresa mais esperada.",
            "Seu carinho foi anotado! Vamos celebrar juntos.",
            "Voto confirmado! Que a espera seja cheia de luz."
        ];

        // --- DOM ELEMENTS ---
        const btnBoy = document.getElementById('btnBoy');
        const btnGirl = document.getElementById('btnGirl');
        const submitBtn = document.getElementById('submitBtn');
        const guestNameInput = document.getElementById('guestName');
        const aiFeedback = document.getElementById('aiFeedback');
        const aiMessageText = document.getElementById('aiMessageText');
        const recentVotesContainer = document.getElementById('recentVotes');

        // --- INITIALIZATION ---
        window.addEventListener('load', () => {
            loadVotes();
            startCountdown();
        });

        // --- FUNCTIONS ---

        // 1. Countdown Logic
        function startCountdown() {
            const container = document.getElementById('countdown');
            
            function update() {
                const now = new Date().getTime();
                const distance = TARGET_DATE - now;

                if (distance < 0) {
                    container.innerHTML = "Chegou o dia!";
                    return;
                }

                const d = Math.floor(distance / (1000 * 60 * 60 * 24));
                const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((distance % (1000 * 60)) / 1000);

                const timeUnit = (val, label) => `
                    <div class="flex flex-col items-center">
                        <div class="w-14 h-14 sm:w-16 sm:h-16 bg-white/50 backdrop-blur-sm rounded-2xl shadow-sm border border-white flex items-center justify-center mb-1">
                            <span class="text-xl sm:text-2xl font-bold text-gray-700 font-heading">${String(val).padStart(2, '0')}</span>
                        </div>
                        <span class="text-[10px] sm:text-xs text-gray-500 font-bold uppercase tracking-widest">${label}</span>
                    </div>`;

                container.innerHTML = `
                    ${timeUnit(d, 'Dias')}
                    <div class="pt-2 text-gray-300 font-bold text-xl">:</div>
                    ${timeUnit(h, 'Hrs')}
                    <div class="pt-2 text-gray-300 font-bold text-xl">:</div>
                    ${timeUnit(m, 'Min')}
                    <div class="pt-2 text-gray-300 font-bold text-xl">:</div>
                    ${timeUnit(s, 'Seg')}
                `;
            }
            setInterval(update, 1000);
            update();
        }

        // 2. Selection Logic
        window.selectGender = (gender) => {
            selectedGender = gender;
            
            // Reset Styles
            btnBoy.className = "cursor-pointer relative group rounded-2xl border-2 p-6 flex flex-col items-center justify-center transition-all duration-300 border-gray-100 bg-white/90 hover:border-blue-200 hover:shadow-lg hover:-translate-y-1";
            btnGirl.className = "cursor-pointer relative group rounded-2xl border-2 p-6 flex flex-col items-center justify-center transition-all duration-300 border-gray-100 bg-white/90 hover:border-pink-200 hover:shadow-lg hover:-translate-y-1";
            
            document.getElementById('iconBoy').className = "w-20 h-20 rounded-full flex items-center justify-center mb-4 bg-blue-100 text-blue-400 group-hover:bg-blue-200 transition-colors";
            document.getElementById('iconGirl').className = "w-20 h-20 rounded-full flex items-center justify-center mb-4 bg-pink-100 text-pink-400 group-hover:bg-pink-200 transition-colors";
            
            document.getElementById('textBoy').className = "font-heading font-black text-xl text-gray-400 group-hover:text-blue-400";
            document.getElementById('textGirl').className = "font-heading font-black text-xl text-gray-400 group-hover:text-pink-400";

            // Apply Active Style
            if (gender === 'BOY') {
                btnBoy.className = "cursor-pointer relative group rounded-2xl border-2 p-6 flex flex-col items-center justify-center transition-all duration-300 border-blue-400 bg-blue-50/80 shadow-[0_0_20px_rgba(59,130,246,0.3)] scale-[1.02] ring-2 ring-blue-200 ring-offset-2";
                document.getElementById('iconBoy').className = "w-20 h-20 rounded-full flex items-center justify-center mb-4 bg-blue-500 text-white";
                document.getElementById('textBoy').className = "font-heading font-black text-xl text-blue-600";
            } else if (gender === 'GIRL') {
                btnGirl.className = "cursor-pointer relative group rounded-2xl border-2 p-6 flex flex-col items-center justify-center transition-all duration-300 border-pink-400 bg-pink-50/80 shadow-[0_0_20px_rgba(236,72,153,0.3)] scale-[1.02] ring-2 ring-pink-200 ring-offset-2";
                document.getElementById('iconGirl').className = "w-20 h-20 rounded-full flex items-center justify-center mb-4 bg-pink-500 text-white";
                document.getElementById('textGirl').className = "font-heading font-black text-xl text-pink-600";
            }

            checkForm();
        };

        guestNameInput.addEventListener('input', checkForm);

        function checkForm() {
            if (guestNameInput.value.trim() && selectedGender) {
                submitBtn.disabled = false;
                submitBtn.className = "w-full py-4 rounded-xl font-bold text-lg text-white shadow-xl flex items-center justify-center gap-2 transition-all transform hover:shadow-2xl active:scale-95 bg-gradient-to-r from-[#5CA0D3] to-[#D86B99] hover:brightness-105 cursor-pointer";
            } else {
                submitBtn.disabled = true;
                submitBtn.className = "w-full py-4 rounded-xl font-bold text-lg text-white shadow-xl flex items-center justify-center gap-2 transition-all transform hover:shadow-2xl active:scale-95 bg-gray-400 cursor-not-allowed";
            }
        }

        // 3. Voting & AI Logic
        document.getElementById('votingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!selectedGender || !guestNameInput.value) return;

            const name = guestNameInput.value;
            submitBtn.innerHTML = "Consultando os astros...";
            submitBtn.disabled = true;

            let aiText = "";

            const pickFallbackMessage = () =>
                fallbackMessages[Math.floor(Math.random() * fallbackMessages.length)];

            // Call Gemini
            if (API_KEY && !API_KEY.includes("PLACEHOLDER")) {
                try {
                    const ai = new GoogleGenAI({ apiKey: API_KEY });
                    const babyName = selectedGender === 'BOY' ? "Miguel" : "Catarina";
                    const genderText = selectedGender === 'BOY' ? "menino" : "menina";
                    
                    const response = await ai.models.generateContent({
                        model: 'gemini-3-flash-preview',
                        contents: `O convidado ${name} acha que o bebê será ${genderText} e se chamará ${babyName}. 
                        Crie uma frase curta, rimada, engraçada e empolgante (máximo 20 palavras) em Português do Brasil agradecendo o voto e fazendo uma previsão divertida.`,
                        config: { thinkingConfig: { thinkingBudget: 0 } }
                    });
                    aiText = response.text;
                } catch (error) {
                    console.error("AI Error", error);
                    aiText = pickFallbackMessage();
                }
            } else {
                aiText = pickFallbackMessage();
            }

            const newVote = {
                id: Date.now().toString(),
                name: name,
                guess: selectedGender,
                timestamp: new Date().toISOString(),
                aiMessage: aiText
            };

            // Save Local
            votes.push(newVote);
            localStorage.setItem('reveal_votes', JSON.stringify(votes));
            
            // Send to Sheet (Fire and Forget)
            fetch(GOOGLE_SHEET_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify(newVote)
            }).catch(e => console.log("Sheet Error", e));

            // Update UI
            renderChart();
            renderRecentVotes();

            // Show Feedback
            aiMessageText.textContent = `"${aiText}"`;
            aiFeedback.classList.remove('hidden');
            
            // Reset Form
            submitBtn.innerHTML = "Voto Confirmado!";
            setTimeout(() => {
                submitBtn.innerHTML = "Confirmar Voto";
                guestNameInput.value = "";
                selectedGender = null;
                // Reset styling (simplified)
                selectGender(null); 
                btnBoy.className = "cursor-pointer relative group rounded-2xl border-2 p-6 flex flex-col items-center justify-center transition-all duration-300 border-gray-100 bg-white/90 hover:border-blue-200";
                btnGirl.className = "cursor-pointer relative group rounded-2xl border-2 p-6 flex flex-col items-center justify-center transition-all duration-300 border-gray-100 bg-white/90 hover:border-pink-200";
                checkForm();
            }, 3000);
        });

        // 4. Data Loading
        function loadVotes() {
            const local = localStorage.getItem('reveal_votes');
            if (local) votes = JSON.parse(local);
            renderChart();
            renderRecentVotes();
            
            // Try fetching from sheet to sync
            fetch(GOOGLE_SHEET_URL)
                .then(r => r.json())
                .then(data => {
                    if (Array.isArray(data) && data.length > 0) {
                        const mapped = data.map(item => ({
                            id: item.id || Math.random().toString(),
                            name: item.name || item.nome || item.guestName || item.convidado,
                            guess: (item.guess === "MIGUEL" || item.guess === "BOY") ? 'BOY' : 'GIRL',
                            timestamp: item.timestamp || item.data || item.date,
                            aiMessage: item.aiMessage
                        }));
                        votes = mapped;
                        localStorage.setItem('reveal_votes', JSON.stringify(votes));
                        renderChart();
                        renderRecentVotes();
                    }
                })
                .catch(e => console.log("Fetch Error", e));
        }

        // 5. Chart Rendering
        function renderChart() {
            const miguelCount = votes.filter(v => v.guess === 'BOY').length;
            const catarinaCount = votes.filter(v => v.guess === 'GIRL').length;
            const total = miguelCount + catarinaCount;

            // Update Text Stats
            const mPct = total === 0 ? 0 : Math.round((miguelCount / total) * 100);
            const cPct = total === 0 ? 0 : Math.round((catarinaCount / total) * 100);
            document.getElementById('statMiguel').textContent = mPct + "%";
            document.getElementById('statCatarina').textContent = cPct + "%";

            // Chart.js
            const ctx = document.getElementById('voteChart').getContext('2d');
            
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Miguel', 'Catarina'],
                    datasets: [{
                        data: [miguelCount, catarinaCount],
                        backgroundColor: ['#5CA0D3', '#D86B99'],
                        borderColor: 'rgba(255, 255, 255, 0.9)',
                        borderWidth: 6,
                        borderRadius: 12,
                        spacing: 4,
                        hoverOffset: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: 6 },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#333',
                            bodyColor: '#666',
                            borderColor: '#ddd',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    return ` ${context.label}: ${context.raw} votos`;
                                }
                            }
                        }
                    },
                    cutout: '70%',
                }
            });
        }

        // 6. Recent Votes Rendering
        function renderRecentVotes() {
            if (!recentVotesContainer) return;

            recentVotesContainer.innerHTML = "";

            const recent = votes.slice(-6).reverse();

            if (recent.length === 0) {
                const empty = document.createElement('p');
                empty.className = "text-sm text-gray-400";
                empty.textContent = "Seja o primeiro a votar!";
                recentVotesContainer.appendChild(empty);
                return;
            }

            const formatTimestamp = (value) => {
                if (!value) return "";
                let date = null;

                if (value instanceof Date) {
                    date = value;
                } else if (typeof value === 'number') {
                    date = new Date(value);
                } else if (typeof value === 'string') {
                    const direct = new Date(value);
                    if (!Number.isNaN(direct.getTime())) {
                        date = direct;
                    } else {
                        const match = value.match(/^(\d{2})\/(\d{2})\/(\d{4})(?:[ ,T]+(\d{2}):(\d{2}))?/);
                        if (match) {
                            const day = Number(match[1]);
                            const month = Number(match[2]) - 1;
                            const year = Number(match[3]);
                            const hour = Number(match[4] || 0);
                            const minute = Number(match[5] || 0);
                            date = new Date(year, month, day, hour, minute);
                        }
                    }
                }

                if (!date || Number.isNaN(date.getTime())) return value;

                const dd = String(date.getDate()).padStart(2, '0');
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const hh = String(date.getHours()).padStart(2, '0');
                const min = String(date.getMinutes()).padStart(2, '0');
                return `${dd}/${mm} ${hh}:${min}`;
            };

            recent.forEach(vote => {
                const row = document.createElement('div');
                row.className = "grid grid-cols-[1fr_auto_auto] items-center gap-3 bg-white/70 border border-white rounded-2xl px-4 py-3 shadow-sm";

                const left = document.createElement('div');
                left.className = "min-w-0";

                const name = document.createElement('span');
                name.className = "text-sm font-semibold text-gray-700 truncate blur-name masked-name";
                name.textContent = vote.name ? vote.name : "Convidado";

                const pill = document.createElement('span');
                const isBoy = vote.guess === 'BOY';
                pill.className = `text-[11px] font-bold uppercase px-2.5 py-1 rounded-full border justify-self-start ${isBoy ? 'bg-blue-50 text-blue-600 border-blue-100' : 'bg-pink-50 text-pink-600 border-pink-100'}`;
                pill.textContent = isBoy ? "Menino" : "Menina";

                const time = document.createElement('span');
                time.className = "text-[11px] font-bold uppercase tracking-widest text-gray-400 justify-self-end";
                time.textContent = formatTimestamp(vote.timestamp);

                left.appendChild(name);
                row.appendChild(left);
                row.appendChild(pill);
                row.appendChild(time);
                recentVotesContainer.appendChild(row);
            });
        }
    </script>
</body>
</html>
